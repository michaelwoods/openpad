name: OpenCode Autofix
on:
  schedule:
    # Run every 4 hours (6 times daily), offset 10min from triage (0,6,12,18)
    - cron: "10 4,8,12,16,20,0 * * *"
  workflow_dispatch:

jobs:
  check-ready:
    runs-on: ubuntu-latest
    outputs:
      has_ready_issues: ${{ steps.count.outputs.has_ready }}
    steps:
      - name: Check for ready-to-start issues
        id: count
        run: |
          count=$(gh issue list --state open --label "ready-to-start" --json number 2>/dev/null | jq 'length // 0')
          echo "Ready-to-start issues: $count"
          if [ "$count" -gt 0 ]; then
            echo "has_ready=true" >> $GITHUB_OUTPUT
          else
            echo "has_ready=false" >> $GITHUB_OUTPUT
          fi

  opencode:
    needs: check-ready
    if: needs.check-ready.outputs.has_ready_issues == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Run OpenCode
        uses: anomalyco/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          model: ${{ vars.OPENCODE_MODEL_THINK }}
          prompt: |
            Act as a Senior Engineer. Resolve ONE high-priority issue.

            ### 1. Selection
            - Scan the top 10 issues.
            - **Priority**: 1. `ready-to-start` + `bug`, 2. `ready-to-start` + `enhancement`, 3. `bug`.
            - If no clear candidate exists, exit.

            ### 2. Implementation
            - Create branch: `opencode-fix/[issue-number]`.
            - Code: Follow `CONTRIBUTING.md` and existing project style.
            - Quality: Add/update tests and ensure robust error handling.
            - Scope: Fix the selected issue ONLY. No unrelated refactoring.

            ### 3. Submission
            - Push branch and open PR to `main`. Refer to `CONTRIBUTING.md` guidelines.
            - Title: Use Conventional Commits (e.g., `fix: ...` or `feat: ...`).
            - Body: Describe the fix and include "Closes #[issue-number]".
